<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>查询</title>
    
    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js" type="text/javascript"></script>
    <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-CN.min.js"></script> -->
    <script type="text/javascript" src="./js/moment.js"></script>

   
    <!-- <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> -->

    <script type="text/javascript" src="./js/bootstrap-datepicker.min.js"></script>
    <script type="text/javascript" src="./locales/bootstrap-datepicker.zh-CN.min.js"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css"> -->
    <link href="./css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="./css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="./css/index.css" rel="stylesheet" type="text/css">
    <style type="text/css">
      .firstText{
        font-size: 25px;
      }
      .navbar{
        min-height: 64px;
      }
      .navbar-default{
        background-color:rgb(165, 212, 241);
      }
      .our-button-style {
        width: 22%;
        margin: 0 37%;
      }
      .myli{
        padding-left:80px;
        padding-top: 5px;
        font-size: 20px;
      }
      .mygroup label{
        font-weight: 400;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid" style="background-color:yellowgreen;">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" style="margin-top:-12px" href="#">
                <img alt="Brand" src="images/logo.png">
            </a>
          </div>
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <p class="navbar-text navbar-left firstText" style="color:white">代谢综合征临床决策支持系统</p>
            <ul class="nav navbar-nav">
                <li class="myli"><a href="#"><img src="images/query3.png">&nbsp&nbsp<strong>病例查询</strong></a></li>
                <li class="myli" style="padding-left: 30px;"><a href="patinfo.html"><img src="images/input2.png">&nbsp&nbsp<strong>信息录入</strong></a></li>
                <li class="myli" style="padding-left: 30px;"><a href="#"><img src="images/outcome1.png">&nbsp&nbsp<strong>诊断结论</strong></a></li>
                <li class="myli" style="padding-left: 30px;"><a href="#"><img src="images/test2.png">&nbsp&nbsp<strong>饮食运动</strong></a></li>
            </ul>
            <button type="button" class="btn btn-default navbar-btn navbar-right" style="margin-top: 17px;margin-right: -10px">退出</button>
          </div>
        </div>
    </nav>
    <h4 style="padding-top:80px;margin-left: 190px;font-size: 16px;color: royalblue;">查询条件</h4>
    <div class="form-inline mygroup" style="margin-left: 200px;font-size:16px">
      <div class="form-group">
        <label for="exampleInputName2">姓&nbsp;&nbsp;&nbsp;&nbsp;名</label>&nbsp;&nbsp;&nbsp;
        <input type="text" class="form-control" id="inputPatName">
      </div>
      <div class="form-group" style="padding-left: 70px;">
        <label>出生日期</label>&nbsp;&nbsp;&nbsp;
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"> 精确
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" disabled> 范围
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio3" checked="checked" value="option3"> 不限
        </label> 
      </div>
      <div class="form-group" style="padding-left: 30px;">
        <div class="input-daterange input-group" id="datepicker">
          <input type="text" class="form-control" name="start">
          <span class="input-group-addon">~</span>
          <input type="text" class="form-control" name="end">
        </div>
      </div>
      <button class="btn" style="margin-left: 100px;background-color: rgb(88, 174, 231);color: white;" onclick="queryPat()">查询</button>
    </div>

    <form class="form-inline mygroup" style="margin-top:15px;margin-left: 200px;font-size:16px">
      <div class="form-group">
        <label for="exampleInputName2">病人ID</label>&nbsp;&nbsp;&nbsp;
        <input type="text" style="margin-left: 2px" class="form-control" id="inputID">
      </div>
      <div class="form-group" style="padding-left: 70px;">
        <label>就诊日期</label>&nbsp;&nbsp;&nbsp;
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio4" value="option1"> 精确
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio5" value="option2"> 范围
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio6" checked="checked" value="option3"> 不限
        </label> 
      </div>
      <div class="form-group" style="padding-left: 30px;">
        <div class="input-daterange input-group" id="datepicker">
          <input type="text" class="form-control" name="start">
          <span class="input-group-addon">~</span>
          <input type="text" class="form-control" name="end">
        </div>
      </div>
      <button type="button" class="btn" style="margin-left: 100px;background-color: rgb(88, 174, 231);color: white;">清空</button>
    </form>
    
    <form class="form-inline mygroup" style="margin-top:15px;margin-left: 200px;font-size:16px">
      <div class="form-group">
        <label for="exampleInputName2">性&nbsp;&nbsp;&nbsp;别</label>&nbsp;&nbsp;&nbsp;
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio7" value="option1"> 男
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio8" checked="checked" value="option2"> 女
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio9" value="option3"> 不限
        </label> 
      </div>
      <div class="form-group" style="padding-left: 71px">
        <label>危险度评估积分</label>&nbsp;&nbsp;&nbsp;
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio10" value="option1" disabled> 精确
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio11" value="option2" disabled> 范围
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="inlineRadio12" checked="checked" value="option3" disabled> 不限
        </label> 
      </div>
      <div class="form-group" style="padding-left: 28px;">       
        <input type="text" class="form-control" disabled>&nbsp;分
        <span style="font-size: 18px;padding-right:20px;padding-left:3px;">~</span>
        <input type="text" class="form-control" disabled>&nbsp;分
      </div>
    </form>
    <div class="container-fluid" style="margin-top:25px">
      <div class="row">
        <div class="col-md-2 col-md-offset-1">
          <div class="panel panel-info">
              <div class="panel-heading">
                  <span style="font-size:16px">查询结果</span>
              </div>
              <!-- Table -->
              <div style="height:260px;width:100%;overflow:auto">
                  <table class="table table-hover" id="patTable">
                      <thead>
                          <tr>
                              <th>病人ID</th>
                              <th>姓名</th>
                              <th>性别</th>
                          </tr>
                      </thead>
                      <tbody id="patient-list"></tbody>
                  </table>
              </div>
          </div>
        </div>
        <div class="col-md-7">
          <div class="panel panel-info">
            <div class="panel-heading">
                <span style="font-size:16px">病史记录</span>
            </div>
            <!-- Table -->
            <div style="height:260px;width:100%;overflow:auto">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>就诊时间</th>
                            <th>代谢综合征</th>
                            <th>危险度</th>
                            <th>危险度评估积分</th> 
                            <th style="width:510px;">缺失信息</th>
                        </tr>
                    </thead>
                    <tbody id="patHistory-list"></tbody>
                </table>
            </div>
        </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      function addPatientItem (Time, Seq, ID, Name, Sex) {
        let List = $(`#patient-list`)
        // visitTime=Time
        let newItem = $(`<tr id=\"pat-list-${Seq}\" rel=\"${Time}\"></tr>`)
        let oneItem = $(`<td>${ID}</td>`)
        let twoItem = $(`<td>${Name}</td>`)
        let threeItem = $(`<td>${Sex}</td>`)
        newItem.click(function(){
          selectedPat = $(this).attr("id").split('pat-list-')[1]
          patRecordSeq = patDict[selectedPat]
          console.log(patRecordSeq)
          console.log(patRecordSeq.join(','))
          selectedTime = $(this).attr("rel")
          // for(var i=0;i<=patRecordSeq.length;i++)
          // {
          //   getSinglePatData(patRecordSeq[i], selectedTime)
          // }
          getSinglePatData(patRecordSeq, selectedTime)
        })
        newItem.append(oneItem)
        newItem.append(twoItem)
        newItem.append(threeItem)
        List.append(newItem)
       }

     function getSinglePatData ( Seq, time ) {
     //let patData = { "recordSeq": Seq }
     let patData = { "recordSeqs": Seq.join(',') }
     $.ajax({
        url : `http://localhost:40415/Service.asmx/QueryDiseaseHistoryByRecordSeq`,
        data: patData,        
        dataType : "xml",
        contentType: "application/x-www-form-urlencoded;charset=utf8",
        method: 'POST',
        success : function(data) {
            //debugger
            console.log(data)
            setDisHistoryTable(data, time)
            //displayAlert(`${selectedPat}数据加载完成`)
        },
        error : function(data) {
            //displayAlert(`${selectedPat}数据加载失败`,'danger')
        }
    })
  }
   function addDisHistoryItem (Time, Syn ,Deg, Sco, Lost) {
     let List = $(`#patHistory-list`)
     let newItem = $(`<tr></tr>`)

     let oneItem = $(`<td>${Time}</td>`)
     let twoItem = $(`<td>${Syn}</td>`)
     let threeItem = $(`<td>${Deg}</td>`)
     let fourItem = $(`<td style="padding-left:50px">${Sco}</td>`)
     let fiveItem = $(`<td>${Lost}</td>`)

     newItem.append(oneItem)
     newItem.append(twoItem)
     newItem.append(threeItem)
     newItem.append(fourItem)
     newItem.append(fiveItem)
     List.append(newItem)
    }
    function clearDisHistoryTable () {
    $(`#patHistory-list`).empty()
    }

    function setDisHistoryTable(data, time){
      var diseases = data.getElementsByTagName('QueryDisHisRecord')
      clearDisHistoryTable()
        //debugger
        if(diseases)
        {
          // clearPatientTable()
          for(var i=0;i<diseases.length;i++)
          {
            var syn=diseases[i].getElementsByTagName('metabolicsSyndrome')[0].innerHTML
            var deg=diseases[i].getElementsByTagName('dangerDegree')[0].innerHTML
            var sco=diseases[i].getElementsByTagName('dangerScore')[0].innerHTML
            var lost = ''
            if (diseases[i].getElementsByTagName('lostInfo')[0])
              lost=diseases[i].getElementsByTagName('lostInfo')[0].innerHTML
            addDisHistoryItem(time, syn ,deg, sco, lost)

          }
        }
      }

      var patDict = {}
      function clearPatientTable () {
        $(`#patient-list`).empty()
      }
        function queryPat(){
          var strName=$('#inputPatName').val()
          var PatID=$('#inputID').val()

        $.ajax({
                url: "http://localhost:40415/Service.asmx/QueryPatDataByCondition",
                data: { },
　　　　         dataType: "xml",
                method: 'POST',
                success: function (res) {
                    //debugger
                    console.log('success~')
                    console.log(res)
                    // PatName = res.getElementsByTagName('PatName')[1].innerHTML
                    // console.log(PatName)
                    var pats = res.getElementsByTagName('QueryPatient')
                    clearPatientTable()
                    //debugger
                    if(pats)
                    {
                      // clearPatientTable()
                      for(var i=0;i<pats.length;i++)
                      {
                        var patSeq=pats[i].getElementsByTagName('PatSEQ')[0].innerHTML
                        var seq=pats[i].getElementsByTagName('RecordSEQ')[0].innerHTML
                        if (!patDict[patSeq]) {
                          patDict[patSeq] = [seq] // tang: [1]
                          var time=pats[i].getElementsByTagName('PatVisitDateTime')[0].innerHTML
                          var ID=pats[i].getElementsByTagName('PatID')[0].innerHTML
                          var name=pats[i].getElementsByTagName('PatName')[0].innerHTML
                          var sex=pats[i].getElementsByTagName('PatSex')[0].innerHTML
                          addPatientItem(time, patSeq, ID, name, sex)
                        } else {
                          patDict[patSeq].push(seq) // tang: [1, 2. 3]
                        }
                      }
                      console.log(patDict) // { tang: [1,2,4,5], 123: [1].... }
                    }
                    // PatList.map (item => {
                    // addPatientItem(item.FollowupTime, item.Done)
                    // })
                },
                error: function (res) {
                    console.log(res)
                }
            })
      }
      
      $('.input-daterange').datepicker({
          language : 'zh-CN',
          autoclose : true,
          todayBtn: true,
          endDate : new Date()
      });
    </script>      

  </body>
</html>